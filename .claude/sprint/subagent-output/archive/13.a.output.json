{
  "story_id": "13",
  "phase": "a",
  "status": "passed",
  "completed_at": "2026-02-13T09:15:00Z",
  "planning_output": {
    "implementation_plan": "Add argparse CLI to scripts/test_server.py with --port, --skip-logs, and --log-age options. Add a new log age check function that inspects the platform-appropriate logs directory for stale log files. Improve the summary output with a clear PASS/FAIL final verdict line. The script currently has no argument parsing (hardcodes port 8765 in check_server_connectivity) and has no log file age checking at all.\n\nKey design decisions:\n1. Use stdlib argparse (not typer/click) since scripts/ uses only stdlib (PRD 13.8 installer constraint pattern)\n2. Import get_logs_dir from daemon.paths for platform-aware log directory resolution (reuse existing path logic)\n3. The --port flag overrides both the config-file port AND the hardcoded fallback (8765) in check_server_connectivity\n4. The --log-age flag accepts an integer (hours) for maximum acceptable log file age\n5. The --skip-logs flag is a boolean store_true that skips the entire log age check\n6. The summary section gets enhanced with a clear final verdict: a bold green 'OVERALL: PASS' or bold red 'OVERALL: FAIL' line plus exit code 0/1\n7. Add tests in tests/test_scripts/ for the new CLI parsing and log age check logic",
    "files_to_modify": [
      "scripts/test_server.py",
      "tests/test_scripts/__init__.py",
      "tests/test_scripts/test_test_server.py"
    ],
    "estimated_complexity": "medium",
    "ac_breakdown": {
      "AC-13.1": "--port option for custom port.\n\nAdd argparse.ArgumentParser to main() with --port (type=int, default=None). Pass the port value through to check_server_connectivity(port_override=None). In check_server_connectivity: if port_override is not None, use it instead of reading from config file / falling back to 8765. This replaces the current hardcoded port=8765 default with a proper override chain: CLI --port > config file > 8765 fallback.\n\nChanges:\n- scripts/test_server.py: Add ArgumentParser at top of main(), add --port arg, pass args.port to check_server_connectivity\n- scripts/test_server.py: Modify check_server_connectivity signature to accept port_override parameter\n- scripts/test_server.py: Update port resolution: port_override or config port or 8765",
      "AC-13.2": "--skip-logs option to skip log file age check.\n\nAdd --skip-logs as a store_true argument. When set, skip calling the new check_log_file_age() function entirely and mark that check as 'SKIP' in the summary (not PASS or FAIL). Print a note like '[SKIP] Log File Age (--skip-logs)' to show it was intentionally skipped.\n\nChanges:\n- scripts/test_server.py: Add --skip-logs argument to ArgumentParser\n- scripts/test_server.py: Conditionally call/skip the log age check based on args.skip_logs\n- scripts/test_server.py: Update summary to show 'SKIP' status for skipped checks",
      "AC-13.3": "--log-age option for max log age.\n\nAdd --log-age (type=int, default=168, metavar='HOURS') for maximum acceptable log file age in hours (default 168 = 7 days). Add new function check_log_file_age(max_age_hours) that:\n1. Uses get_logs_dir() from daemon.paths to find the platform-appropriate logs directory\n2. If logs dir doesn't exist, reports FAIL with 'Logs directory not found'\n3. Scans for log files (*.log, *.log.gz) in the logs directory\n4. If no log files found, reports FAIL with 'No log files found'\n5. Checks mtime of newest log file against max_age_hours\n6. If newest log is older than max_age_hours, reports FAIL with age details\n7. If newest log is within max_age_hours, reports PASS with age details\n\nNote: Need try/except around the daemon.paths import since scripts/ may run before package installation. Fall back to a manual platform detection (similar to existing get_config_paths() in the script) if import fails.\n\nChanges:\n- scripts/test_server.py: Add --log-age argument to ArgumentParser\n- scripts/test_server.py: Add check_log_file_age(max_age_hours) function\n- scripts/test_server.py: Add get_logs_dir_fallback() for when daemon.paths is not importable\n- scripts/test_server.py: Wire log age check into main() check sequence",
      "AC-13.4": "Clear pass/fail output.\n\nEnhance the summary section at the end of main():\n1. Add three-state display: PASS (green), FAIL (red), SKIP (yellow) for each check\n2. Add a prominent final verdict line: 'OVERALL: PASS' (all passed/skipped) or 'OVERALL: FAIL' (any failed)\n3. Include counts: 'X passed, Y failed, Z skipped out of N checks'\n4. Exit code 0 for all-pass, 1 for any failure (already exists but reinforce)\n5. The existing print_status function already handles PASS/FAIL well; extend the summary section formatting\n\nChanges:\n- scripts/test_server.py: Modify results list to use 3-state (pass/fail/skip) instead of boolean\n- scripts/test_server.py: Update summary section with enhanced formatting and OVERALL verdict\n- scripts/test_server.py: Add SKIP status color (yellow) to summary display"
    },
    "testing_strategy": "Create tests/test_scripts/test_test_server.py with:\n1. Test argparse parsing: verify --port, --skip-logs, --log-age are parsed correctly with defaults\n2. Test check_log_file_age with mocked filesystem: create temp dir with log files of various ages, verify pass/fail\n3. Test check_log_file_age with missing logs dir\n4. Test check_log_file_age with empty logs dir\n5. Test check_server_connectivity with port_override parameter (mock urlopen)\n6. Test summary output formatting with various result combinations (all pass, some fail, some skip)\n7. Test that --skip-logs results in SKIP status, not PASS or FAIL\n\nAll tests should mock external I/O (network calls, filesystem paths) to run in CI without a live server.",
    "dependencies": []
  }
}
