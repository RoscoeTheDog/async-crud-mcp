{
  "story_id": "4",
  "phase": "a",
  "status": "passed",
  "completed_at": "2026-02-13T04:00:00Z",
  "planning_output": {
    "implementation_plan": "Create `src/async_crud_mcp/core/path_validator.py` implementing a `PathValidator` class that enforces base directory whitelisting with cross-platform path normalization. The validator resolves all paths to absolute, resolves symlinks before validation, rejects traversal attempts, and normalizes paths per-platform (case-insensitive on Windows via `os.path.normcase`). A custom `PathValidationError` exception is raised on violations. The class is initialized with a list of base directories from the config system (Story 2's `CrudConfig.base_directories`). Tests go in `tests/test_path_validator.py` covering each AC with parametrized cases for cross-platform edge cases.",
    "files_to_modify": [
      "src/async_crud_mcp/core/path_validator.py",
      "src/async_crud_mcp/core/__init__.py",
      "tests/test_path_validator.py"
    ],
    "estimated_complexity": "medium",
    "ac_breakdown": {
      "AC-4.1": "Base directory whitelist enforcement: Create `PathValidator` class initialized with `base_directories: list[str]`. Implement `validate(path: str) -> Path` method that resolves the given path to absolute, resolves symlinks, normalizes (normpath + normcase), then checks that the resolved path starts with at least one of the resolved+normalized base directories. If no base directory matches, raise `PathValidationError` with a message indicating the path is outside allowed directories. If `base_directories` is empty, all paths are allowed (no restriction). Store resolved base directories at init time to avoid re-resolving on every call. Use `os.path.normcase()` for case-insensitive matching on Windows.",
      "AC-4.2": "Absolute path resolution: Within `validate()`, convert relative paths to absolute using `Path.resolve()` or `os.path.abspath()`. This handles both relative paths (resolved against CWD) and paths with `~` (though tilde expansion is not typically needed for MCP paths). The method always returns an absolute `Path` object regardless of input format. Also handle Windows long path prefix (`\\\\?\\`) for paths >240 characters per PRD 13.11.",
      "AC-4.3": "Symlink resolution BEFORE base directory check: Use `os.path.realpath()` to resolve all symlinks in the path BEFORE checking against base directories. This prevents symlink escape attacks where a symlink inside a base directory points to a location outside it. Both the input path and all base directories are resolved with `realpath()` at their respective times (base dirs at init, input paths at validation time). This is the critical security property - the real filesystem location is what gets validated.",
      "AC-4.4": "Reject `..` traversal after resolution: After resolving the path to absolute and resolving symlinks, verify the final resolved path does not escape the base directory. This is inherently handled by the `startswith` check on fully-resolved paths (since `os.path.realpath` canonicalizes away `..`). Additionally, as a defense-in-depth measure, verify the resolved path string does not contain `..` components by checking `os.path.normpath(resolved)` equals `resolved` (i.e., no `..` segments remain). The `startswith` check on resolved paths is the primary defense; the `..` check is secondary.",
      "AC-4.5": "Cross-platform path normalization: (1) Use `os.path.normpath()` to normalize separators and remove redundant components. (2) Use `os.path.normcase()` to lowercase paths on Windows for case-insensitive comparison. (3) Handle Windows UNC paths (`\\\\server\\share\\...`) by detecting them and validating them against UNC base directories. (4) Normalize path separators before any comparison (`os.sep` consistency). (5) For the `startswith` base directory check, compare normalized paths to avoid false negatives from separator/case differences. All normalization happens after symlink resolution but before the base directory check."
    },
    "testing_strategy": "Create `tests/test_path_validator.py` with pytest. Test categories: (1) Basic validation - paths inside base dirs pass, paths outside fail with PathValidationError. (2) Multiple base directories - path valid if inside ANY base dir. (3) Empty base directories list - all paths allowed. (4) Relative path resolution - relative inputs resolved to absolute. (5) Symlink handling - create temp symlinks pointing inside/outside base dirs, verify correct resolution behavior. (6) Traversal rejection - paths with `..` that escape base dirs are rejected even if they look valid before resolution. (7) Cross-platform normalization - case sensitivity tests (parametrized to match OS behavior), separator normalization. (8) Edge cases - empty path string, path equal to base dir itself, path that is a prefix but not a child (e.g., base=/foo/bar, path=/foo/barbaz should fail). (9) Windows long paths (conditional on platform). Use `tmp_path` fixture for temp directories and symlinks.",
    "dependencies": []
  }
}
