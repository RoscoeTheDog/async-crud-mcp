{
  "story_id": "17",
  "phase": "a",
  "status": "passed",
  "completed_at": "2026-02-12T22:45:00Z",
  "planning_output": {
    "implementation_plan": "Implement three Windows-specific daemon modules by adapting the daemon-service template snippets to the async-crud-mcp codebase. The template snippets at claude-code-tooling/claude-mcp/daemon-service/resources/snippets/windows/ provide production-tested reference implementations with all critical bug fixes (BUG-01 through BUG-13) and architectural decisions (ADR-008, ADR-011, ADR-012) already incorporated.\n\nThe three files are:\n1. bootstrap_service.py - pywin32 Windows Service class (DaemonService) that wraps the MultiUserDispatcher\n2. dispatcher.py - MultiUserDispatcher that manages per-user MCP server worker processes\n3. session_detector.py - Windows-specific WTS API session detection\n\nAll three files follow the existing patterns in the daemon/ package: platform guards at module top, pywin32 imports with ImportError handling, loguru logging with enqueue=True, and consistent use of APP_NAME from paths.py.\n\nKey integration points:\n- bootstrap_service.py imports MultiUserDispatcher from dispatcher.py\n- dispatcher.py imports get_user_config_file_path, get_user_logs_dir, _get_user_profile_path from daemon.paths (already implemented in story 16)\n- installer.py already references 'from .windows_service import install_service' - need to create a windows_service.py shim or update installer.py to import from .windows.bootstrap_service instead\n- windows/__init__.py needs exports for the public API\n- pywin32>=306 dependency is already declared in pyproject.toml",
    "files_to_modify": [
      "src/async_crud_mcp/daemon/windows/bootstrap_service.py",
      "src/async_crud_mcp/daemon/windows/dispatcher.py",
      "src/async_crud_mcp/daemon/windows/session_detector.py",
      "src/async_crud_mcp/daemon/windows/__init__.py",
      "src/async_crud_mcp/daemon/installer.py"
    ],
    "estimated_complexity": "high",
    "ac_breakdown": {
      "AC-17.1": "bootstrap_service.py: Implement DaemonService class extending win32serviceutil.ServiceFramework. CRITICAL: ReportServiceStatus(SERVICE_RUNNING) must be the FIRST line of SvcDoRun() to prevent SCM error 1053 (BUG-01). Use WindowsSelectorEventLoopPolicy with manual event loop creation (ADR-011) - do NOT use asyncio.run() which fails with 'signal only works in main thread' in service context (BUG-02/10). Include: (1) _svc_name_, _svc_display_name_, _svc_description_ class attributes, (2) GetAcceptedControls() accepting SERVICE_ACCEPT_SESSIONCHANGE, (3) SvcOtherEx() forwarding WTS_SESSION_LOGON/LOGOFF events to dispatcher, (4) SvcStop() setting stop_event and dispatcher.running=False, (5) SvcDoRun() with the exact pattern from PRD section 13.2. Also implement install_service() using direct win32service.CreateService() API with PythonClass registry key (GAP-4, BUG-11 - do NOT use HandleCommandLine), uninstall_service(), start_service(), stop_service(). Update installer.py to import install_service/uninstall_service from windows.bootstrap_service instead of the nonexistent windows_service module.",
      "AC-17.2": "bootstrap_service.py: Wrap ALL SvcDoRun() logic in try/except Exception block (BUG-07). In the except handler, call servicemanager.LogErrorMsg(f'Service failed: {e}') as a backstop error logger. This ensures crashes are recorded in the Windows Event Log even when file-based logging fails. The try/except must wrap everything after ReportServiceStatus, including dispatcher creation and the async event loop. Also wrap dispatcher creation itself in a separate try/except that logs and returns early on failure.",
      "AC-17.3": "dispatcher.py: Implement MultiUserDispatcher class with multi-user process management. Key behaviors: (1) _enumerate_existing_sessions() on startup using WTSEnumerateSessions to find already-logged-in users, (2) on_session_logon(session_id) to create UserWorker and start per-user MCP server via CreateProcessAsUser, (3) on_session_logoff(session_id) to stop worker only when last session for user ends (username is worker key, tracks session_ids: set[int] for multi-session same user), (4) _poll_workers() for health checking with stale process cleanup (BUG-13), config hot-reload, and port-level health monitoring (ADR-012), (5) _check_port_available()/_kill_port_owner()/_find_port_owner() for three-layer port conflict detection (ADR-012 pre-start layer), (6) logging fallback chain: ProgramData -> LocalAppData -> Temp (BUG-05/06/GAP-8), (7) SYSTEM_ACCOUNTS frozenset to skip system users, (8) UserWorker dataclass tracking username, session_ids, user_token, config_path, process_handle, etc. Import paths from daemon.paths (get_user_config_file_path, get_user_logs_dir, _get_user_profile_path - all already exist from story 16). Replace template placeholders: [APP_NAME]->async-crud-mcp, [PACKAGE_NAME]->async_crud_mcp, [DEFAULT_PORT]->8720.",
      "AC-17.4": "dispatcher.py: In _start_worker(), use win32process.CreateProcessAsUser with creation flags that include CREATE_NEW_PROCESS_GROUP so the entire child process tree can be terminated on shutdown (PRD 13.9). Currently the template uses CREATE_NO_WINDOW | CREATE_UNICODE_ENVIRONMENT - add CREATE_NEW_PROCESS_GROUP to this bitmask. This is critical for clean worker termination. Also use subprocess.DEVNULL or file redirect (never PIPE) for stderr to prevent 64KB buffer deadlock (BUG-04). The template already redirects stderr to a per-user log file under get_user_logs_dir().",
      "AC-17.5": "session_detector.py: Implement Windows-specific WTS API session detection module. Provides get_active_sessions() returning list of lowercase usernames using WTSEnumerateSessions + WTSQuerySessionInformation. Filters by WTSActive and WTSConnected states. Also provides is_user_session_active(username) and get_session_details(username) for detailed session info including state mapping. Platform guard at top (raise ImportError if not win32). Direct import of win32ts (not try/except like the cross-platform version). The cross-platform session_detector.py in daemon/ already delegates to this pattern for Windows via _get_windows_sessions() - this dedicated module provides richer functionality for the dispatcher's direct use."
    },
    "testing_strategy": "Testing Windows service modules is challenging since they require pywin32 and Windows Service infrastructure. Strategy: (1) Unit tests should mock pywin32 APIs (win32serviceutil, win32service, win32event, servicemanager, win32ts, win32process, win32api, win32profile, win32con) to test logic without requiring actual Windows service registration. (2) Test DaemonService.SvcDoRun() calls ReportServiceStatus first (BUG-01 verification). (3) Test MultiUserDispatcher.on_session_logon/logoff with mocked WTS - verify multi-session tracking (add session, remove session, only stop on last). (4) Test SYSTEM_ACCOUNTS filtering. (5) Test port conflict detection helpers with mocked sockets. (6) Test logging fallback chain by controlling environment variables. (7) Test _get_python_executable() with mocked sys.executable paths. (8) Integration: manual testing on Windows with 'sc create/start/stop/query'. Tests should be skipped on non-Windows platforms using pytest.mark.skipif(sys.platform != 'win32').",
    "dependencies": []
  }
}
