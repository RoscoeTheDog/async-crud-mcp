{
  "story_id": "2",
  "phase": "a",
  "status": "passed",
  "completed_at": "2026-02-12T21:00:00Z",
  "planning_output": {
    "implementation_plan": "Create `src/async_crud_mcp/config.py` with pydantic-settings BaseSettings models for the four configuration sections (daemon, crud, persistence, watcher) plus a root Settings model. Use nested model pattern with `env_nested_delimiter='__'` and `env_prefix='ASYNC_CRUD_MCP_'` for environment variable overrides. Support JSON config file loading via `settings_customise_sources` override. Add `tests/test_config.py` for unit tests covering all ACs.\n\n## File: src/async_crud_mcp/config.py (CREATE)\n\n### Constants\n- `APP_NAME = \"async-crud-mcp\"` - Single constant per PRD 13.6 (used for config paths, service names, etc.)\n\n### Sub-models (plain pydantic BaseModel, nested inside root Settings)\n\n1. **DaemonConfig(BaseModel)**:\n   - `enabled: bool = True`\n   - `host: str = \"127.0.0.1\"`\n   - `port: int | None = 8720` (None = auto-assign via username hash)\n   - `transport: Literal[\"sse\", \"stdio\"] = \"sse\"`\n   - `log_level: str = \"DEBUG\"`\n   - `config_poll_seconds: int = 3`\n   - `config_debounce_seconds: float = 1.0`\n   - `session_poll_seconds: int = 3`\n   - `wait_for_session: bool = True`\n   - `health_check_interval: int = 30`\n\n2. **CrudConfig(BaseModel)**:\n   - `base_directories: list[str] = []` (list of absolute paths)\n   - `default_timeout: float = 30.0`\n   - `max_timeout: float = 300.0`\n   - `default_encoding: str = \"utf-8\"`\n   - `diff_context_lines: int = 3`\n   - `max_file_size_bytes: int = 10_485_760` (10MB)\n\n3. **PersistenceConfig(BaseModel)**:\n   - `enabled: bool = False`\n   - `state_file: str | None = None` (None = default DATA_DIR location)\n   - `write_debounce_seconds: float = 1.0`\n   - `ttl_multiplier: float = 2.0`\n\n4. **WatcherConfig(BaseModel)**:\n   - `enabled: bool = True`\n   - `debounce_ms: int = 100`\n\n### Root model\n\n5. **Settings(BaseSettings)**:\n   - `daemon: DaemonConfig = DaemonConfig()`\n   - `crud: CrudConfig = CrudConfig()`\n   - `persistence: PersistenceConfig = PersistenceConfig()`\n   - `watcher: WatcherConfig = WatcherConfig()`\n   - `model_config = SettingsConfigDict(env_prefix=\"ASYNC_CRUD_MCP_\", env_nested_delimiter=\"__\")`\n   - Override `settings_customise_sources()` to add JSON file source via `json_file` parameter or explicit `JsonConfigSettingsSource`\n\n### Helper function\n\n6. **`get_settings(config_path: Path | None = None) -> Settings`**:\n   - If `config_path` provided, load from that JSON file\n   - Otherwise, construct Settings from env vars + defaults\n   - This is the main entry point other modules will use\n\n## File: tests/test_config.py (CREATE)\n\n### Test cases\n- `test_default_values()` - All defaults match PRD (port 8720, timeout 30s, etc.)\n- `test_daemon_section_fields()` - DaemonConfig has all expected fields\n- `test_crud_section_fields()` - CrudConfig has all expected fields\n- `test_persistence_section_fields()` - PersistenceConfig has all expected fields\n- `test_watcher_section_fields()` - WatcherConfig has all expected fields\n- `test_env_var_override(monkeypatch)` - Set ASYNC_CRUD_MCP_DAEMON__PORT=9999 and verify\n- `test_nested_env_var_override(monkeypatch)` - Set ASYNC_CRUD_MCP_CRUD__DEFAULT_TIMEOUT=60.0\n- `test_json_config_loading(tmp_path)` - Write JSON config file, load it, verify values\n- `test_json_config_partial_override(tmp_path)` - JSON file with partial config merges with defaults\n- `test_settings_sections_exist()` - Root Settings has daemon, crud, persistence, watcher attributes",
    "files_to_modify": [
      "src/async_crud_mcp/config.py",
      "tests/test_config.py"
    ],
    "estimated_complexity": "medium",
    "ac_breakdown": {
      "AC-2.1": "Create four nested Pydantic BaseModel sub-models (DaemonConfig, CrudConfig, PersistenceConfig, WatcherConfig) with all fields from PRD Section 5. Compose them into a root Settings(BaseSettings) class with `daemon`, `crud`, `persistence`, `watcher` attributes. Each field has type annotations and defaults matching the PRD JSON schema exactly.",
      "AC-2.2": "Configure pydantic-settings with `env_prefix='ASYNC_CRUD_MCP_'` and `env_nested_delimiter='__'` in the Settings model_config (SettingsConfigDict). This enables automatic environment variable overrides like ASYNC_CRUD_MCP_DAEMON__PORT=8720, ASYNC_CRUD_MCP_CRUD__DEFAULT_TIMEOUT=60.0, ASYNC_CRUD_MCP_PERSISTENCE__ENABLED=true. The double-underscore delimiter maps to nested model fields. Test with monkeypatch to verify env vars override defaults.",
      "AC-2.3": "Set all default values in the field definitions to match PRD Section 5 exactly: port=8720, default_timeout=30.0, max_timeout=300.0, host='127.0.0.1', transport='sse', log_level='DEBUG', enabled(daemon)=True, enabled(persistence)=False, enabled(watcher)=True, debounce_ms=100, max_file_size_bytes=10485760, etc. Test each default explicitly.",
      "AC-2.4": "Override `settings_customise_sources()` on the Settings class to add a JSON config file source. Use pydantic-settings' built-in `JsonConfigSettingsSource` (available in pydantic-settings v2). The JSON file path is passed as a parameter. Source priority: env vars > JSON file > defaults. Provide `get_settings(config_path=None)` helper that constructs Settings with optional JSON file path. Test by writing a JSON config to tmp_path, loading it, and verifying values override defaults."
    },
    "testing_strategy": "Create `tests/test_config.py` with pytest. Tests cover: (1) default values match PRD for all sections, (2) env var overrides via monkeypatch for both simple and nested fields, (3) JSON config file loading from a tmp_path file with full and partial configs, (4) all four sections exist as attributes on the root Settings model. No async tests needed - config is synchronous. Use pytest's monkeypatch fixture for env vars and tmp_path for JSON files.",
    "dependencies": []
  }
}
