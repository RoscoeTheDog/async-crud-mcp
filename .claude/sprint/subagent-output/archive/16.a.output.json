{
  "story_id": "16",
  "phase": "a",
  "status": "passed",
  "completed_at": "2026-02-12T22:00:00Z",
  "planning_output": {
    "implementation_plan": "Story 16 implements 9 daemon infrastructure modules by adapting the daemon-service template snippets to the async-crud-mcp project. The template files at C:\\Users\\Admin\\Documents\\GitHub\\claude-code-tooling\\claude-mcp\\daemon-service\\resources\\snippets\\common\\ provide the canonical implementation patterns. Each module requires replacing placeholders ([APP_NAME] -> 'async-crud-mcp', [PACKAGE_NAME] -> 'async_crud_mcp', [DEFAULT_PORT] -> 8720) and integrating with the existing config.py from Story 2.\n\nKey integration points:\n1. paths.py imports APP_NAME from config.py (or redefines it consistently per ADR-009)\n2. config_watcher.py uses the Settings pydantic model from config.py for ResilientConfigLoader\n3. health.py imports from paths.py for config/logs discovery\n4. bootstrap_daemon.py imports from paths.py, session_detector.py, and uses loguru\n5. config_init.py provides setup wizard functionality integrated with the existing Settings model\n\nAll modules use loguru (not stdlib logging), enqueue=True for thread safety, and await logger.complete() in finally blocks. Cross-platform support is mandatory (Windows, macOS, Linux) with Windows service context detection.",
    "files_to_modify": [
      "src/async_crud_mcp/daemon/__init__.py",
      "src/async_crud_mcp/daemon/paths.py",
      "src/async_crud_mcp/daemon/logging_setup.py",
      "src/async_crud_mcp/daemon/graceful_shutdown.py",
      "src/async_crud_mcp/daemon/session_detector.py",
      "src/async_crud_mcp/daemon/config_init.py",
      "src/async_crud_mcp/daemon/config_watcher.py",
      "src/async_crud_mcp/daemon/health.py",
      "src/async_crud_mcp/daemon/installer.py",
      "src/async_crud_mcp/daemon/bootstrap_daemon.py"
    ],
    "estimated_complexity": "medium",
    "ac_breakdown": {
      "AC-16.1": "paths.py: Adapt template common/paths.py. Replace [APP_NAME] with 'async-crud-mcp'. Import APP_NAME from config.py to maintain ADR-009 single-constant convention. Implement all 12 exported functions: get_install_dir(), get_config_dir(), get_logs_dir(), get_data_dir(), get_shared_dir(), get_shared_python_dir(), get_shared_uv_dir(), get_user_dir(), get_venv_dir(), get_config_file_path(), get_user_config_file_path(), get_user_logs_dir(). Internal helpers: _get_platform(), _get_xdg_path(), _is_windows_service_context(), _get_user_profile_path(). Platform detection: Windows (LOCALAPPDATA/PROGRAMDATA fallback for service context), macOS (~/Library), Linux (XDG). Dirs are NOT created automatically - callers must mkdir().",
      "AC-16.2": "logging_setup.py: Adapt template common/logging_setup.py. Configure loguru with enqueue=True (CRITICAL for async safety), rotation='10 MB', retention='7 days', compression='gz', serialize=True for JSON file output. Console format with colors for dev, FILE_FORMAT without colors. setup_logging() accepts log_level, console, file, log_dir, serialize_file, diagnose_console, diagnose_file, service_mode params. service_mode skips console handler when stdout is None or not a tty. get_logger(name) returns context-bound logger. add_request_context() for request tracing. Import log_dir from paths.py get_logs_dir(). Fallback chain for Windows service context: PROGRAMDATA -> LOCALAPPDATA -> TEMP (PRD 12.2). diagnose=False in production to prevent variable value leaks.",
      "AC-16.3": "graceful_shutdown.py: Adapt template common/graceful_shutdown.py. ShutdownHandler class with: signal registration wrapped in try/except ValueError (Windows service non-main thread), SIGTERM/SIGINT handlers, callback list, wait_for_shutdown(), context manager support. AsyncShutdownHandler with asyncio.Event for async contexts, loop.add_signal_handler() with NotImplementedError fallback for Windows. graceful_stop() function with timeout and force_after parameters. shutdown_context() context manager. The 'await logger.complete()' call is in bootstrap_daemon.py's finally block, not in this module - but this module provides the mechanism to trigger shutdown.",
      "AC-16.4": "session_detector.py: Adapt template common/session_detector.py. Two exported functions: get_active_sessions() -> List[str] and is_user_session_active(username) -> bool. Platform dispatch: Windows uses WTS API (win32ts.WTSEnumerateSessions, WTSActive/WTSConnected states, WTSQuerySessionInformation for username), macOS uses stat -f '%Su' /dev/console (ignoring root/_windowserver/loginwindow system users), Linux uses /run/user/{uid} directories (systemd-logind, uid >= 1000 filter via pwd.getpwuid). All usernames normalized to lowercase. Suitable for 3-second polling intervals with minimal overhead.",
      "AC-16.5": "config_init.py: Adapt template common/config_init.py. Replace [APP_NAME]='async-crud-mcp', [DEFAULT_PORT]=8720. Functions: get_config_dir(), get_config_file_path(), get_logs_dir(), get_user_logs_dir(), get_user_config_file_path() (legacy compat, prefer paths.py). _strip_comment_fields() removes _-prefixed and $-prefixed keys. load_settings_from_file() with fallback to defaults. find_available_port(start=8720, end=8820) using socket.bind() test (PRD 11.3). generate_default_config() matching the Settings model sections. init_config() with optional interactive prompts via typer (with input() fallback). Integrate with existing Settings pydantic model for validation. _is_windows_service_context() for service detection.",
      "AC-16.6": "config_watcher.py: Adapt template common/config_watcher.py. ConfigWatcher class with: mtime-based change detection, debounce protection (default 1.0s per PRD 13.7) to prevent reading partial JSON during editor saves, check_for_changes() returning bool, reset() method. ResilientConfigLoader generic class parametrized on pydantic BaseModel (use Settings from config.py): load() with last-known-good fallback on ValidationError or JSONDecodeError, _strip_comment_fields(), has_fallback property. atomic_write_config() for safe config updates. PRD 13.7 mandates debounce and last-known-good caching.",
      "AC-16.7": "health.py: Adapt template common/health.py. Replace [DEFAULT_PORT]=8720. Import from .paths (get_config_file_path, get_logs_dir). _is_port_listening(host, port, timeout=2.0) using socket connect_ex (PRD ADR-012). check_health() verifies: config file readable and valid JSON, daemon_enabled status, logs_dir exists, port accepting connections (only if daemon enabled). Returns dict with status ('healthy'/'degraded'/'unhealthy'), config_readable, daemon_enabled, logs_dir_exists, port_listening, host, port, message. This supports the health endpoint (PRD 11.2: GET /health) and CLI daemon status command.",
      "AC-16.8": "installer.py: Adapt template common/installer.py. Replace [APP_NAME]='async-crud-mcp'. InstallerBase ABC with abstract methods: install(**kwargs), uninstall(), start(), stop(), status() -> str, list() -> list[str]. WindowsServiceInstaller: uses sc commands for start/stop/status/list, delegates install/uninstall to windows_service module (Story 17 scope). LaunchdInstaller: skeleton with NotImplementedError (Story 18 scope). SystemdInstaller: skeleton with NotImplementedError (Story 18 scope). get_installer() factory dispatches on sys.platform. SERVICE_NAME = 'async-crud-mcp-daemon'.",
      "AC-16.9": "bootstrap_daemon.py: Adapt template common/bootstrap_daemon.py. Replace [APP_NAME]='async-crud-mcp', [PACKAGE_NAME]='async_crud_mcp'. BootstrapDaemon class with: configure_logging() using paths.get_logs_dir() with rotation and conditional console output, signal handlers in try/except ValueError, async run() main loop polling session state and config changes, _load_settings() with mtime detection, _get_python_executable() multi-candidate search for Windows service context (sys.prefix/Scripts, venv/Scripts, exe_dir), _start_mcp_server() launching 'python -m async_crud_mcp.server' with stderr to file (not PIPE - PRD BUG-04), _stop_mcp_server() with terminate+wait+kill fallback, _cleanup_process(). The run() method's finally block calls 'await logger.complete()' to drain enqueued log messages (PRD 12.1 MANDATORY)."
    },
    "testing_strategy": "Tests for Story 16 are deferred to Story 21 (unit tests - core components). However, the implementation should be structured for testability:\n\n1. paths.py: Test each path function on current platform, verify platform detection, mock environment variables for cross-platform testing\n2. logging_setup.py: Test setup_logging creates handlers, verify enqueue=True is set, test service_mode skips console\n3. graceful_shutdown.py: Test ShutdownHandler callback registration, test signal handling simulation, test context manager\n4. session_detector.py: Mock platform-specific APIs (win32ts, /run/user), test get_active_sessions returns list, test is_user_session_active\n5. config_init.py: Test find_available_port with mock socket, test generate_default_config structure, test init_config creates file\n6. config_watcher.py: Test debounce timing, test ResilientConfigLoader fallback behavior, test _strip_comment_fields\n7. health.py: Test check_health with mocked config/port, test _is_port_listening with mock socket\n8. installer.py: Test get_installer returns correct platform class, test ABC interface\n9. bootstrap_daemon.py: Test _get_python_executable candidate search, test lifecycle management\n\nEach module includes a __main__ block for manual smoke testing.",
    "dependencies": [
      "Story 2 (configuration system) - COMPLETED: provides config.py with Settings, DaemonConfig, APP_NAME",
      "loguru>=0.7 - already in pyproject.toml dependencies",
      "pywin32>=306 - already in pyproject.toml (win32 conditional)",
      "pydantic>=2.0 - already in pyproject.toml",
      "daemon-service template snippets at C:\\Users\\Admin\\Documents\\GitHub\\claude-code-tooling\\claude-mcp\\daemon-service\\resources\\snippets\\common\\"
    ]
  }
}
