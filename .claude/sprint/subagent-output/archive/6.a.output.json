{
  "story_id": "6",
  "phase": "a",
  "status": "passed",
  "completed_at": "2026-02-13T12:00:00Z",
  "planning_output": {
    "implementation_plan": "Refactor setup_cmd.py to implement the spec's 6-step setup wizard flow with CLI options. The wizard() function currently has a 3-step flow (config, write config, install daemon). It needs to become a 6-step flow: (1) prerequisites check, (2) find available port, (3) create per-user directories, (4) write config + install daemon (existing steps 2-3), (5) configure Claude Code CLI, (6) verify server connectivity. Additionally, --port, --no-interactive, and --force must be added as CLI options to the setup command itself.\n\nKey design decisions:\n- The wizard() function signature changes to accept typer.Option parameters for --port, --no-interactive, --force\n- Non-interactive mode skips all Prompt.ask/Confirm.ask calls and uses defaults/CLI-provided values\n- Prerequisites check verifies Python version and checks that required packages are importable\n- No admin required is enforced by NOT checking for admin (unlike install_cmd which does check on Windows). On Unix, user-level services (launchd/systemd --user) don't need admin. On Windows, the setup wizard should work without elevation\n- Claude Code CLI configuration creates/updates the MCP server entry in Claude Code's config\n- Server connectivity verification reuses _is_port_listening from health.py after daemon start\n- The _is_admin() check from install_cmd is deliberately NOT used in setup - the wizard should work without admin",
    "files_to_modify": [
      "src/async_crud_mcp/cli/setup_cmd.py",
      "tests/test_cli/test_setup_cmd.py"
    ],
    "estimated_complexity": "medium",
    "ac_breakdown": {
      "AC-6.1": "Add --port (int, optional), --no-interactive (bool, default False), and --force (bool, default False) as typer.Option parameters to the wizard() function. --port overrides the default/auto-discovered port. --no-interactive suppresses all interactive prompts (Prompt.ask, Confirm.ask) and uses defaults or CLI-provided values. --force passes through to init_config(force=True) to overwrite existing config without asking. When --no-interactive is set: skip the 'Overwrite existing configuration?' confirm (use force value), skip port/host/transport/log_level prompts (use defaults or --port), skip 'Install daemon?' confirm (default to yes). The function signature becomes: wizard(port: int = typer.Option(None, '--port', help='Server port'), no_interactive: bool = typer.Option(False, '--no-interactive', help='Disable interactive prompts'), force: bool = typer.Option(False, '--force', help='Overwrite existing configuration')).",
      "AC-6.2": "Add Step 1: Check prerequisites at the start of the wizard flow (after the welcome panel). Prerequisites to check: (1) Python >= 3.10 via sys.version_info, (2) required packages importable: fastmcp, pydantic, loguru - wrap each in try/except ImportError. Display a checklist with green checkmarks for passing items. If any prerequisite fails, print an error message and raise typer.Exit(code=1). In non-interactive mode, same behavior but no prompts.",
      "AC-6.3": "Add Step 2: Find available port. Call find_available_port(start=port or DEFAULT_PORT) to auto-discover if default/specified port is in use. If the CLI --port was provided, try that specific port first (bind test), and if in use, warn and fall back to auto-discover. In interactive mode, show the discovered port and allow the user to override. In non-interactive mode, use the discovered port silently. Import DEFAULT_PORT from config_init.",
      "AC-6.4": "Add Step 3: Create per-user directories. Call get_config_dir() and get_logs_dir() from daemon.paths, then mkdir(parents=True, exist_ok=True) on each. Print the created/verified directory paths. This ensures config and logs directories exist before writing config.",
      "AC-6.5": "Add Step 5: Configure Claude Code CLI. After daemon installation (Step 4), attempt to configure the Claude Code CLI to know about this MCP server. This involves: (1) Find claude config file at ~/.claude/claude_desktop_config.json or platform equivalent, (2) Read existing config or create new one, (3) Add/update the mcpServers entry for async-crud-mcp with the configured host:port SSE URL. If the config file doesn't exist or Claude CLI isn't installed, print a warning but don't fail - this is a best-effort step. Use json.load/json.dump for the config file. In non-interactive mode, same behavior.",
      "AC-6.6": "Add Step 6: Verify server connectivity. After starting the daemon (if it was started), wait briefly (1-2 seconds with time.sleep) then call _is_port_listening(host, port) from daemon.health to verify the server is accepting connections. Display success (green) or failure (yellow warning - don't fail the wizard, just warn). If the daemon was not installed (user declined in interactive mode), skip this step. Import _is_port_listening from daemon.health.",
      "AC-6.7": "No admin required: Do NOT add any _is_admin() check to the setup wizard. The wizard should work for non-admin users. On Unix, launchd (macOS) and systemd --user (Linux) don't require root. On Windows, if the service installation step fails due to lack of admin, catch the exception and print a helpful message suggesting the user run quick-install with admin privileges instead, but don't block the config/directory creation steps. The wizard should complete the config steps successfully even without admin."
    },
    "testing_strategy": "Update tests/test_cli/test_setup_cmd.py to cover the new 6-step flow and CLI options:\n\n1. test_wizard_with_port_option: Invoke with ['setup', '--port', '9000'] and verify port is used\n2. test_wizard_no_interactive: Invoke with ['setup', '--no-interactive'] and verify no prompts are called, defaults are used\n3. test_wizard_force_option: Invoke with ['setup', '--force'] and verify init_config called with force=True\n4. test_wizard_prerequisites_pass: Mock imports succeeding, verify step 1 passes\n5. test_wizard_prerequisites_fail: Mock an ImportError for fastmcp, verify exit code 1\n6. test_wizard_port_discovery: Mock find_available_port returning a non-default port, verify it's used\n7. test_wizard_directory_creation: Verify get_config_dir().mkdir and get_logs_dir().mkdir are called\n8. test_wizard_claude_config: Mock the Claude config file path, verify JSON is written with mcpServers entry\n9. test_wizard_connectivity_check_success: Mock _is_port_listening returning True, verify success message\n10. test_wizard_connectivity_check_failure: Mock _is_port_listening returning False, verify warning (not error)\n11. test_wizard_no_admin_required: Verify _is_admin is never called in setup_cmd\n12. test_wizard_install_fails_without_admin: Mock installer.install raising OSError, verify wizard continues with warning\n13. Update existing tests (test_wizard_new_config, test_wizard_existing_config_no_overwrite, test_wizard_no_install) to account for the new steps (mock new dependencies like mkdir, _is_port_listening, etc.)",
    "dependencies": []
  }
}
