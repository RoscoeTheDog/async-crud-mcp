{
  "story_id": "6",
  "phase": "a",
  "status": "passed",
  "completed_at": "2026-02-12T22:15:00Z",
  "planning_output": {
    "implementation_plan": "Create `src/async_crud_mcp/core/file_io.py` implementing atomic file write operations and SHA-256 content hashing. The module provides two main capabilities: (1) an `atomic_write` function that writes content via mkstemp temp file + fsync + os.replace with cross-platform guardrails, and (2) a `compute_hash` function for SHA-256 content hashing in `sha256:<hex>` format. A `HashRegistry` class maintains an in-memory mapping of normalized file paths to their latest hashes. Cross-platform concerns include: Windows PermissionError retry with exponential backoff on os.replace, cross-filesystem rename fallback (copy + fsync + delete), fsync on parent directory for Linux durability, and raw bytes hashing (no line ending normalization). The module uses only stdlib (hashlib, tempfile, os, shutil) plus tenacity for retry logic (already in project dependencies). Tests go in `tests/test_file_io.py`.",
    "files_to_modify": [
      "src/async_crud_mcp/core/file_io.py",
      "src/async_crud_mcp/core/__init__.py",
      "tests/test_file_io.py"
    ],
    "estimated_complexity": "medium",
    "ac_breakdown": {
      "AC-6.1": "Implement `atomic_write(target_path: str, content: bytes) -> None` function. Steps: (1) Get target directory via os.path.dirname. (2) Create temp file with `tempfile.mkstemp(dir=target_dir, prefix='.tmp_')` - same directory guarantees same filesystem for the common case. (3) Write content via `os.write(fd, content)`. (4) Call `os.fsync(fd)` to flush to disk. (5) Close the fd (MUST close before os.replace on Windows). (6) Call `os.replace(tmp_path, target_path)` with retry wrapper for Windows. (7) On any exception: close fd if still open, unlink tmp_path, re-raise. (8) Optionally fsync parent directory on Linux (AC-6.5). Pattern follows PRD section 13.10 exactly.",
      "AC-6.2": "Implement `compute_hash(data: bytes) -> str` that returns `f'sha256:{hashlib.sha256(data).hexdigest()}'`. Also implement `compute_file_hash(file_path: str) -> str` that reads a file in binary mode and hashes it. For files up to max_file_size_bytes (10MB config), use `hashlib.file_digest()` (Python 3.11+, project requires 3.12+) for streaming hash computation. Format is always `sha256:<64-char-hex-digest>`. Implement `HashRegistry` class with dict[str, str] mapping normalized paths (via `os.path.normcase(os.path.normpath(os.path.realpath(path)))`) to hash strings. Methods: `get(path) -> str | None`, `update(path, hash_value) -> None`, `remove(path) -> None`, `snapshot() -> dict`, `restore(state: dict) -> None`.",
      "AC-6.3": "Implement `_replace_with_retry(src: str, dst: str) -> None` using tenacity retry decorator. On Windows (`sys.platform == 'win32'`): retry on `PermissionError` up to 3 attempts with exponential backoff (wait 0.05s, 0.1s, 0.2s). On non-Windows: no retry, just call `os.replace(src, dst)` directly. The tenacity library is already in pyproject.toml dependencies. Use `@retry(retry=retry_if_exception_type(PermissionError), stop=stop_after_attempt(3), wait=wait_exponential(multiplier=0.05, min=0.05, max=0.2), reraise=True)` or equivalent conditional logic.",
      "AC-6.4": "Implement cross-filesystem rename fallback in `atomic_write`. Before calling `os.replace`, compare `os.stat(tmp_path).st_dev` with `os.stat(target_dir).st_dev`. If different filesystems: (1) copy tmp_path to target via `shutil.copy2(tmp_path, target_path)`, (2) fsync the destination file, (3) delete tmp_path, (4) return a boolean flag `cross_filesystem=True` for callers to include in response. Note: In the normal atomic_write flow, mkstemp is in the same dir so this shouldn't trigger. This fallback is primarily for the rename tool (Story 10) where source and dest may differ. Expose as a separate `safe_rename(src: str, dst: str) -> bool` function returning whether cross-filesystem fallback was used.",
      "AC-6.5": "After `os.replace()` succeeds, if `sys.platform != 'win32'` (i.e., Linux/macOS): open the parent directory with `os.open(parent_dir, os.O_RDONLY)`, call `os.fsync(dir_fd)`, then `os.close(dir_fd)`. Wrap in try/except OSError to handle cases where directory fsync is not supported (e.g., some virtual filesystems). On Windows, skip this step entirely (not needed and O_RDONLY on directories doesn't work).",
      "AC-6.6": "The `compute_hash` function takes `bytes` not `str`. All callers must encode string content to bytes using the file's encoding BEFORE passing to hash. The `compute_file_hash` function opens files in binary mode (`'rb'`). No line ending normalization (`\\r\\n` vs `\\n`) - hash the raw bytes as they exist on disk. This means the same logical content will produce different hashes on different platforms if line endings differ, which is the correct behavior per PRD 13.14. Document this in the function docstring."
    },
    "testing_strategy": "Create `tests/test_file_io.py` with the following test classes: (1) `TestComputeHash` - test hash format `sha256:<hex>`, deterministic output, empty bytes hash, large content hash. (2) `TestComputeFileHash` - test reading real files in binary mode, verify hash matches manual computation, test with files containing mixed line endings (verify no normalization). (3) `TestAtomicWrite` - test basic write creates file with correct content, test temp file cleanup on failure, test overwrite existing file atomically, test with unicode content. (4) `TestReplaceWithRetry` - test successful replace, test Windows PermissionError retry (mock os.replace to fail then succeed), test max retries exceeded. (5) `TestCrossFilesystemFallback` - test same-filesystem path (mock st_dev equal), test cross-filesystem detection (mock st_dev different), test fallback copy+delete. (6) `TestFsyncParentDirectory` - test Linux path (mock sys.platform to 'linux'), test Windows path skips fsync. (7) `TestHashRegistry` - test get/update/remove, test path normalization, test snapshot/restore. All tests use tmp_path fixture and pytest-asyncio where needed.",
    "dependencies": []
  }
}
