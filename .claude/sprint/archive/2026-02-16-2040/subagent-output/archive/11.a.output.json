{
  "story_id": "11",
  "phase": "a",
  "status": "passed",
  "completed_at": "2026-02-13T12:00:00Z",
  "planning_output": {
    "implementation_plan": "Enhance scripts/installer.py from a simplified ~340-line installer to a full-featured spec-compliant installer. The current installer has basic install/uninstall/configure/test subcommands via argparse but is missing: (1) --force/--port options on install, (2) --all option on uninstall, (3) privilege checks, (4) preflight checks, (5) uv venv --managed-python, (6) pywin32 DLL configuration, and (7) structured exit codes.\n\nThe approach enhances the existing scripts/installer.py in-place, preserving its stdlib-only design (no typer/rich dependency since this runs before the venv exists). The CLI install_cmd.py (typer-based) already has --force/--port/--no-start and admin checks from Story 7, so this story focuses on the standalone installer script.\n\nKey design decisions:\n- Keep stdlib-only (argparse, subprocess, os, sys, shutil, json, platform, socket) since installer runs before venv creation\n- Exit codes as module-level constants: EXIT_SUCCESS=0, EXIT_FAILED=1, EXIT_CANCELLED=130\n- Preflight checks run before any installation step and abort early on failure\n- pywin32 DLL configuration happens after package install but before service install\n- --managed-python flag for uv venv replaces the current --python 3.12 hardcode\n- uninstall --all removes venv + config + logs + base directory without individual prompts",
    "files_to_modify": [
      "scripts/installer.py",
      "scripts/uninstaller.py",
      "tests/test_cli/test_install_cmd.py"
    ],
    "estimated_complexity": "medium",
    "ac_breakdown": {
      "AC-11.1": "Add --force and --port options to the 'install' subcommand in scripts/installer.py. Currently the argparse parser has subcommands (install, uninstall, configure, test, menu) but no options on 'install'. Add: --force/-f (overwrite existing config/venv), --port/-p (override default port, passed to init_config). Modify do_install() to accept and use these parameters. When --force is set, skip 'config already exists' checks and recreate venv. When --port is provided, pass it to the init_config() function to write into config.json. Update the argparse subparser for 'install' with these two options.",
      "AC-11.2": "Add --all option to the 'uninstall' subcommand in scripts/installer.py. Currently uninstall delegates to uninstaller.py. Instead, integrate uninstall logic directly or add --all flag that passes through. When --all is set: stop service, uninstall service, remove venv, remove config dir, remove logs dir, remove base dir - all without individual confirmation prompts (equivalent to uninstaller.py --yes). Also update scripts/uninstaller.py to accept --all as an alias for removing everything. Add --all to the argparse uninstall subparser.",
      "AC-11.3": "Add privilege/admin check before installation on Windows. Add a check_privileges() function that uses ctypes.windll.shell32.IsUserAnAdmin() on Windows (same pattern as install_cmd.py _is_admin()). On non-Windows, return True (user-level services via systemd --user / launchd don't need root). Call check_privileges() at the start of do_install() and do_uninstall(). If not admin on Windows, print error message and return EXIT_FAILED. The check is stdlib-only (ctypes is stdlib).",
      "AC-11.4": "Add preflight checks before installation. Create a run_preflight_checks() function that validates: (1) Python version >= 3.10 using sys.version_info, (2) Disk space >= 500MB free at the installation target using shutil.disk_usage(), (3) Write permissions to the target directory by attempting os.makedirs()/os.access(). Return a list of (check_name, passed, message) tuples. Print results in a summary table. If any check fails, abort installation with EXIT_FAILED. Call run_preflight_checks() after privilege check but before any installation steps in do_install().",
      "AC-11.5": "Update create_venv() to use 'uv venv --managed-python' (ADR-010) instead of the current 'uv venv <dir> --python 3.12'. The --managed-python flag tells uv to download and manage its own Python distribution, removing the dependency on system Python matching exactly 3.12. Change the subprocess call from ['uv', 'venv', str(venv_dir), '--python', '3.12'] to ['uv', 'venv', str(venv_dir), '--managed-python']. This aligns with ADR-010 which specifies using uv's managed Python for reproducible environments.",
      "AC-11.6": "Add pywin32 DLL configuration step for Windows Service (GAP-5). After package installation in the venv, pywin32 needs its DLLs (pywintypes3X.dll, pythoncom3X.dll) copied to a location where pythonservice.exe can find them. Add a configure_pywin32_dlls(venv_dir) function that: (1) Only runs on Windows, (2) Finds the pywin32 DLL directory (venv/Lib/site-packages/pywin32_system32/), (3) Copies pywintypes*.dll and pythoncom*.dll to the venv root (where pythonservice.exe expects them), (4) Also copies pythonservice.exe from pywin32's win32/ directory to the venv root. Uses shutil.copy2() for all copies. Called after install_package() and before install_service() in do_install().",
      "AC-11.7": "Add structured exit codes throughout the installer. Define module-level constants: EXIT_SUCCESS = 0, EXIT_FAILED = 1, EXIT_CANCELLED = 130. Update main() to use these constants instead of bare 0/1. Add KeyboardInterrupt handler in main() that prints cancellation message and returns EXIT_CANCELLED. Update show_menu() to catch KeyboardInterrupt and return EXIT_CANCELLED. Update do_install() and do_uninstall() to return appropriate exit codes. Ensure all sys.exit() calls use these constants."
    },
    "testing_strategy": "Update tests/test_cli/test_install_cmd.py to verify the CLI-level --force/--port/--all options still work correctly (these already exist from Story 7). Add new test file tests/test_scripts_installer.py for the standalone scripts/installer.py with tests for: (1) preflight checks passing/failing with mocked sys.version_info and shutil.disk_usage, (2) check_privileges() returning correct values on mocked platforms, (3) create_venv() calling uv with --managed-python flag, (4) configure_pywin32_dlls() copying correct files on mocked Windows, (5) exit code constants exist and have correct values, (6) --force flag behavior in do_install(), (7) --all flag behavior in uninstall. All tests should mock subprocess.run and filesystem operations to avoid side effects.",
    "dependencies": []
  }
}
