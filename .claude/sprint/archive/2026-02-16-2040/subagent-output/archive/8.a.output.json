{
  "story_id": "8",
  "phase": "a",
  "status": "passed",
  "completed_at": "2026-02-13T08:15:00Z",
  "planning_output": {
    "implementation_plan": "Add port validation, host validation, Settings.from_file() class method, singleton get_settings() with _force_reload, and _strip_comment_fields() to config.py. All changes are localized to src/async_crud_mcp/config.py and tests/test_config.py.\n\n## AC-8.1: Port validation (ge=1024, le=65535 or null)\nIn DaemonConfig, change the port field from `port: int | None = 8720` to use a Pydantic Field with ge/le constraints. Since the port can be None (auto-assign), use a field_validator or annotated type. The cleanest approach is:\n```python\nport: int | None = Field(default=8720, ge=1024, le=65535)\n```\nPydantic v2 applies ge/le constraints only when the value is not None for Optional fields. Verify this behavior; if not, use a @field_validator to skip validation when None.\n\n## AC-8.2: Host validation (non-empty string)\nAdd a field_validator on host to reject empty strings:\n```python\nfrom pydantic import field_validator\n\n@field_validator('host')\n@classmethod\ndef host_must_not_be_empty(cls, v: str) -> str:\n    if not v or not v.strip():\n        raise ValueError('host must be a non-empty string')\n    return v\n```\n\n## AC-8.3: Settings.from_file(config_path) class method\nAdd a class method to Settings that loads config from a JSON file, stripping comment fields before passing to pydantic:\n```python\n@classmethod\ndef from_file(cls, config_path: Path | str) -> 'Settings':\n    path = Path(config_path)\n    if not path.exists():\n        return cls()\n    raw = json.loads(path.read_text(encoding='utf-8'))\n    cleaned = _strip_comment_fields(raw)\n    return cls(**cleaned)\n```\nThis avoids the global _json_config_file hack currently used by get_settings().\n\n## AC-8.4: get_settings() singleton with _force_reload\nConvert get_settings() to a singleton pattern with a module-level cache:\n```python\n_settings_cache: Settings | None = None\n\ndef get_settings(config_path: Path | str | None = None, *, _force_reload: bool = False) -> Settings:\n    global _settings_cache\n    if _settings_cache is not None and not _force_reload and config_path is None:\n        return _settings_cache\n    # ... existing logic to create Settings ...\n    _settings_cache = settings\n    return settings\n```\nWhen _force_reload=True or config_path is provided, bypass the cache and reload. This matches the spec requirement while maintaining backward compatibility with existing callers (server.py, config_cmd.py).\n\n## AC-8.5: _strip_comment_fields() for _/$-prefixed comment removal\nAdd a module-level function to config.py (currently only exists in config_init.py and config_watcher.py as separate implementations). This is the canonical implementation:\n```python\ndef _strip_comment_fields(data: dict) -> dict:\n    if not isinstance(data, dict):\n        return data\n    return {\n        k: _strip_comment_fields(v) if isinstance(v, dict) else v\n        for k, v in data.items()\n        if not k.startswith('_') and not k.startswith('$')\n    }\n```\nThis matches the existing pattern in config_init.py:199 and is used by Settings.from_file().",
    "files_to_modify": [
      "src/async_crud_mcp/config.py",
      "tests/test_config.py"
    ],
    "estimated_complexity": "medium",
    "ac_breakdown": {
      "AC-8.1": "Add Field(ge=1024, le=65535) constraint to DaemonConfig.port. Since port is `int | None`, verify Pydantic v2 skips ge/le when value is None. If not, add @field_validator that returns None passthrough. Add tests: valid ports (1024, 8720, 65535), invalid ports (0, 1023, 65536, -1), and None (auto-assign).",
      "AC-8.2": "Add @field_validator('host') to DaemonConfig that rejects empty/whitespace-only strings. Add tests: valid hosts ('127.0.0.1', 'localhost', '0.0.0.0'), invalid hosts ('', '  ').",
      "AC-8.3": "Add Settings.from_file(config_path) classmethod that reads JSON, strips comment fields via _strip_comment_fields(), and constructs Settings(**cleaned). Returns default Settings() if file doesn't exist. Add tests: from_file with valid JSON, with comment fields, with nonexistent file, with partial config.",
      "AC-8.4": "Add module-level _settings_cache and modify get_settings() to cache the result. Add _force_reload keyword-only parameter that bypasses cache. When config_path is provided, always reload (don't use stale cache). Add tests: singleton returns same object, _force_reload returns fresh object, config_path bypasses cache.",
      "AC-8.5": "Add _strip_comment_fields(data) module-level function that recursively removes keys starting with _ or $. Used internally by Settings.from_file(). Add tests: strips _comment, strips $schema, recurses into nested dicts, handles non-dict input."
    },
    "testing_strategy": "Extend tests/test_config.py with new test functions:\n- test_port_validation_valid_range: ports 1024, 8720, 65535 accepted\n- test_port_validation_invalid_range: ports 0, 1023, 65536 raise ValidationError\n- test_port_validation_none_allowed: None accepted for auto-assign\n- test_host_validation_nonempty: valid hosts accepted\n- test_host_validation_empty_rejected: empty string raises ValidationError\n- test_host_validation_whitespace_rejected: whitespace-only raises ValidationError\n- test_settings_from_file: loads config from JSON file\n- test_settings_from_file_with_comments: strips _/$-prefixed keys\n- test_settings_from_file_nonexistent: returns defaults\n- test_get_settings_singleton: same object returned on repeated calls\n- test_get_settings_force_reload: returns fresh object\n- test_strip_comment_fields: unit test for the helper function\n\nAll existing tests must continue to pass. The singleton change means existing tests that call Settings() directly are unaffected, but tests calling get_settings() may need cleanup (monkeypatch the cache).",
    "dependencies": []
  }
}
