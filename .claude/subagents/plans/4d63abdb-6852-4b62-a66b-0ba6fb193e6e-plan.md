# Plan: Fix Windows Service Error 1053 (Complete)

## Context

Three root causes identified through cross-repo comparison with claude-jsonl-mcp
and pywin32 C source analysis (`PythonService.cpp`, CPython `PyImport_Import`).
All three must be fixed for the service to start reliably.

---

## Fixes (Execution Order)

### Fix 1: Remove Editable Install (ROOT CAUSE)

**File**: `scripts/installer.py` L161

The `-e` flag causes `sys.path` to include the developer's source tree
(`C:\Users\Admin\Documents\GitHub\...`). When the service runs as LocalSystem,
it cannot access another user's profile. Import fails silently -> error 1053.

**Change**: Remove `-e` from the `uv pip install` command:
```python
# Before:
["uv", "pip", "install", "-e", str(project_root), "--python", str(python_path)]
# After:
["uv", "pip", "install", str(project_root), "--python", str(python_path)]
```

**Also add**: Post-install import verification (ADR-015 C5):
```python
subprocess.run([str(python_path), "-c", f"import {PACKAGE_NAME}"], check=True, ...)
```

### Fix 2: DLL Copying (ALREADY DONE)

**File**: `scripts/installer.py` L174-237

Already implemented in prior session. `_get_base_python_dir()` reads `pyvenv.cfg`
to find uv-managed Python, copies `python3.dll`, `python312.dll`, `vcruntime140.dll`,
`vcruntime140_1.dll` to venv root alongside `pythonservice.exe`.

**Status**: Complete. Tests passing (498/498).

### Fix 3: Flatten Daemon Modules (ADR-016)

Restructure from nested subpackages to flat layout matching the template and
claude-jsonl-mcp reference implementation.

#### 3a. Move Windows files to daemon/ level

**Move** (not copy) these files:
- `daemon/windows/windows_service.py` -> `daemon/windows_service.py`
- `daemon/windows/dispatcher.py` -> `daemon/dispatcher.py`
- `daemon/windows/session_detector.py` -> already exists at `daemon/session_detector.py`

**Delete**: `daemon/windows/__init__.py` and `daemon/windows/` directory

**Update internal imports** in moved files:
- `from .dispatcher import MultiUserDispatcher` (no change needed - relative import still works)
- Any `from ..paths import ...` becomes `from .paths import ...` (one level up removed)

#### 3b. Rewrite daemon/__init__.py to eager imports

**Replace** the lazy `__getattr__` pattern with eager conditional imports:

```python
import sys

from .bootstrap_daemon import BootstrapDaemon
from .config_init import init_config, load_settings_from_file
from .config_watcher import ConfigWatcher, ResilientConfigLoader
from .graceful_shutdown import AsyncShutdownHandler, ShutdownHandler, graceful_stop, shutdown_context
from .health import check_health
from .installer import get_installer
from .logging_setup import get_logger, setup_logging
from .paths import (APP_NAME, get_cache_dir, get_config_dir, get_config_file_path,
                    get_data_dir, get_install_dir, get_logs_dir, get_shared_dir,
                    get_shared_python_dir, get_shared_uv_dir, get_user_config_file_path,
                    get_user_dir, get_user_logs_dir, get_venv_dir)
from .session_detector import get_active_sessions, is_user_session_active

if sys.platform == 'win32':
    try:
        from .dispatcher import MultiUserDispatcher
        from .windows_service import (
            DaemonService, install_service, uninstall_service,
            start_service, stop_service,
        )
    except ImportError:
        pass
```

#### 3c. Update PythonClass registry path

In `daemon/windows_service.py`, the `service_class_string` is computed as
`f'{__name__}.{cls.__name__}'`. After flattening, `__name__` becomes
`async_crud_mcp.daemon.windows_service` (was `...daemon.windows.windows_service`).

This means the PythonClass registry value changes automatically on next
`install_service()`. Existing installations need a reinstall to update the registry.

#### 3d. Update any imports from other modules

Search for `from async_crud_mcp.daemon.windows` or `from .windows import` and
update to the new flat paths. Key files to check:
- `src/async_crud_mcp/daemon/installer.py` (may import from windows subpackage)
- `src/async_crud_mcp/server.py`
- `tests/` (any test importing from daemon.windows)

#### 3e. Delete daemon/linux/ and daemon/macos/ if they follow the same subpackage pattern

Check if these exist as subpackages and flatten them too.

---

## Verification

After all three fixes:

1. **Reinstall**: `python scripts/installer.py install --force`
2. **Check sys.path**: No developer source directories in venv Python's sys.path
3. **Check DLLs**: `python3.dll`, `python312.dll` in venv root
4. **Check registry**: PythonClass = `async_crud_mcp.daemon.windows_service.DaemonService`
5. **Start service**: `sc start async-crud-mcp-daemon` (no error 1053)
6. **Run tests**: `uv run pytest tests/ -x`
7. **Test server**: `python scripts/test_server.py --skip-logs --retries 3`

---

## Files to Modify

| File | Change |
|------|--------|
| `scripts/installer.py` L161 | Remove `-e` flag, add import verification |
| `src/async_crud_mcp/daemon/__init__.py` | Replace lazy `__getattr__` with eager conditional imports |
| `src/async_crud_mcp/daemon/windows_service.py` | Move from `daemon/windows/` to `daemon/` |
| `src/async_crud_mcp/daemon/dispatcher.py` | Move from `daemon/windows/` to `daemon/` |
| `src/async_crud_mcp/daemon/windows/__init__.py` | DELETE |
| `src/async_crud_mcp/daemon/windows/` | DELETE (directory) |
| Various test files | Update imports from `daemon.windows.X` to `daemon.X` |

## ADR References

- **ADR-015**: Windows Service Deployment Pre-Flight Checklist (C1-C7)
- **ADR-016**: Flat Daemon Module Layout with Eager Imports
